<html>

<head>
    <script src="jquery-3.6.0.js"></script>
    <script src="codemirror.js"></script>
    <link rel="stylesheet" href="codemirror.css">
    <script src="clike/clike.js"></script>

    <style>
    #filename {
        width:70%;
    }

    #codeview {
        z-index: -1;
        left: 0px;
        top: 0px;
        bottom: 0px;
        right: 0px;
    }

    .CodeMirror pre {
      z-index: -1;
    }

    tr.h {
        height: 3em;
        margin-top:0px;
    }

    tr.filemode {
        left: 0px;
        top: 0px;
        bottom: 0px;
        right: 0px;
    }

    td {
        vertical-align: top;
    }

    #layouttable {
        height: 100%;
        width: 100%;
    }

    .marker {
        background-color: #ffc800;
        padding:2px;
    }

    </style>

    <script>
        $(document).ready(function() {

            var codeview = document.getElementById('codeview');
            var editor = CodeMirror(codeview, {
                mode:  "clike",
                lineNumbers: true,
                readOnly: true
            });
            $(".filemode").hide();
            $(".dirmode").hide();

            var update_file = function() {
               var repo = $('#repo').val();
               var ref = $('#ref').val();
               var filter = $('#filter').val();
               var filename = $('#filename').val();
               $.ajax({url: `/~/graphql/${repo}.git`,
                  contentType: "application/json",type:'POST',
                  data: JSON.stringify({ query:`{ 
                      rev(at:"${ref}", filter:"${filter}") {
                          file(path:"${filename}") {
                            text
                            markers(topic: "review") {
                              list {
                                position
                                text
                              }
                            }
                          }
                          dirs(at:"${filename}",depth: 1) { path, markers(topic:"review") { count } }
                          files(at:"${filename}",depth: 1) { path, markers(topic:"review") { count } }
                      }
                  }`}),
                  success: function(result) {
                      if(!result.data) {
                        $("#filename").val("");
                        return;
                      }
                      if(result.data.rev.file) {
                        $(".dirmode").hide();
                        $(".filemode").show();
                        editor.setSize("100%", "100%");
                        editor.getDoc().setValue(result.data.rev.file.text);

                        console.log(result.data.rev.file);
                        var r = result.data.rev.file.markers.list;
                        for (var i = 0; i < r.length; i++) {
                            console.log(r);
                            var msg = document.createElement("div");
                            msg.innerHTML = r[i].text;
                            msg.className = "marker";
                            editor.addLineWidget(parseInt(r[i].position)-1, msg, {coverGutter: false, noHScroll: true});
                        }

                        return;
                      }
                        $(".filemode").hide();
                        $(".dirmode").show();
                      if(result.data.rev.dirs) {
                        var paths = [];
                        var r = result.data.rev.dirs;
                        for (var i = 0; i < r.length; i++) {
                            if (r[i].markers.count) {
                                paths.push(`<li><span class="path">${r[i].path}</span><span class="marker">${r[i].markers.count}</span></li>`);
                            }
                            else {
                                paths.push(`<li><span class="path">${r[i].path}</span></li>`);
                            }
                        }
                        $("#dirs").html(paths.join(''));
                      }
                      if(result.data.rev.files) {
                        var paths = [];
                        var r = result.data.rev.files;
                        for (var i = 0; i < r.length; i++) {
                            if (r[i].markers.count) {
                                paths.push(`<li><span class="path">${r[i].path}</span><span class="marker">${r[i].markers.count}</span></li>`);
                            }
                            else {
                                paths.push(`<li><span class="path">${r[i].path}</span></li>`);
                            }
                        }
                        $("#files").html(paths.join(''));
                      }

                      if(!result.data.rev.dirs && !result.data.rev.files) {
                          $("#filename").val("");
                          update_file();
                      }

                  }
               });
            };

            $("#dirs").on("click", "span.path", function() {
               var filename = $('#filename').val();
                $('#filename').val($(this).html());
               update_file();
            });

            $("#files").on("click", "span.path", function() {
               var filename = $('#filename').val();
                $('#filename').val($(this).html());
               update_file();
            });

            $("#up").click(function() {
               var filename = $('#filename').val();
               var f = filename.split("/");
               f.pop();
                $('#filename').val(f.join("/"));
                update_file();
            });

            $("#ws").click(function() {
               var filename = $('#filename').val();
                $('#filter').val(`:workspace=${filename}`);
                update_file();
            });

            $("#nop").click(function() {
               var filename = $('#filename').val();
                $('#filter').val(":nop");
                update_file();
            });

            $( "#fileform" ).submit(function( event ) {
                update_file();

                event.preventDefault();
            });

            $("#repo").val(window.location.hash.substr(1));

            var update_refs = function() {
               var repo = $('#repo').val();
               $.ajax({url: `/~/graphql/${repo}.git`,
                  contentType: "application/json",type:'POST',
                  data: JSON.stringify({ query:`{ refs { name } }`}),
                  success: function(result) {
                        var options = [];
                        var r = result.data.refs;
                        for (var i = 0; i < r.length; i++) {
                            options.push(`<option value="${r[i].name}">${r[i].name}</option>`);
                        }
                        $("#ref").html(options.join(''));
                        $("#ref").val("refs/heads/master");
                        update_file();
                  }
               });
            };
            update_refs();

            $( "#revform" ).submit(function( event ) {
                update_file();
                event.preventDefault();
            });

        });

    </script>
</head>

<body>

<table id="layouttable">
    <tr class="h">
        <td>
            <form id="revform">
                <input id="repo" value="" readonly/>
                <select id="ref" value="refs/heads/master"/>
                <input id="filter" value=":nop"/>
                <input type="button" id="ws" value="ws"/>
                <input type="button" id="nop" value="nop"/>
                <input type="submit"/>
            </form>
            <form id="fileform">
                <input type="button" id="up" value="Up"/>
                <input id="filename" value="README.md"/>
                <input type="submit"/>
            </form>
        </td>
    </tr>

    <tr class="dirmode">
        <td>
            <ul id="dirs"></ul>
        </td>
    </tr>
    <tr class="dirmode">
        <td>
            <ul id="files"></ul>
        </td>
    </tr>
    <tr class="filemode">
        <td id="codeview">
        </td>
    </tr>
</table>

</body>

</html>
